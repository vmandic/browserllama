# Command: Smart Senior Engineer JavaScript Code Review

Trigger: review-code (or as configured)

## Primer

Follow the project rules in **`.llm/rules/`** as the general context for this review: scope and edits (where to change, smallest change), testing (when to run tests, honest reporting), decisions (no guessing; propose options if unclear), **javascript_style.mdc** (JS and Chrome extension conventions), and any other rules that apply to the changed files. Use them to judge correctness, style, and alignment with project goals.

---

Perform a senior-level JavaScript code review using **local changes** and **git history** of the touched files. Do not modify code unless the user explicitly asks for fixes.

## Input and Scope

1. **Determine scope**: Use `git status` and `git diff` to identify changed files. If the user points at specific paths or branches, limit the review to those.
2. **Gather history**: For each changed file, run `git log -p --follow -n <N> -- <file>` (e.g. N=5–10) to get recent history and context of how the file evolved.
3. **Read current and previous versions**: Read the full contents of each changed file and, when useful, the previous version (e.g. `git show HEAD:path/to/file`) to compare before/after.
4. **Apply project context**: Read AGENTS.md and, for extension code, relevant parts of `src/` (e.g. manifest, background, popup) so the review respects Chrome extension constraints and project goals.

## Output Structure

Produce exactly the following five sections. Keep each section scoped and actionable. Section 5 includes running all standard build, lint, and test scripts for this project.

---

### 1. Changes overview (max 5 bullets)

- Summarize what changed at a high level: which areas (e.g. popup, background, lib, tests), what was added/removed/refactored.
- Use at most **5 bullets**; prefer one bullet per logical change or file group.
- No code blocks here; keep it short.

---

### 2. Breaking changes (with before → after fix)

- List any changes that **break** existing behavior, APIs, or contracts (e.g. message actions, storage keys, function signatures, exports).
- For each breaking change provide:
  - **What breaks**: brief description and where (file/line or symbol).
  - **Before**: current (problematic) snippet or behavior.
  - **After**: recommended fix (code or concrete steps).
- If there are no breaking changes, say so explicitly in one line.

---

### 3. Risks overview

- Call out **risks** only: regressions, edge cases, performance, security, or stability (e.g. async/port lifecycle, storage, CORS, error paths).
- Group by severity if useful (high/medium/low). Be concise; 3–7 bullets typical.
- Do not repeat the “breaking changes” list here; focus on runtime and operational risks.

---

### 4. Improvement suggestions (before → after)

- Suggest **non-breaking** improvements: style, readability, error handling, consistency with `.llm/rules/javascript_style.mdc`, naming, structure.
- For each suggestion provide:
  - **Before**: current snippet or pattern.
  - **After**: recommended code or pattern.
- Limit to the most valuable 3–6 items; skip nitpicks.

---

### 5. Build, lint, and test run

- **Standard scripts to run**: From the project root, run every **build/lint/format** script that exists in `package.json`. For this project type (JS, Chrome extension, pnpm), check for and run (when present):
  - `pnpm run build` – build/compile step
  - `pnpm run lint` or `pnpm run lint:check` – static analysis
  - `pnpm run format` or `pnpm run format:check` – format check (do not auto-fix unless the command is explicitly a fix command)
  - `pnpm run typecheck` – type checking (if the project uses TypeScript/JSDoc)
  - Any other `check`, `validate`, or `ci` script that is part of the normal quality gate
- **Report build/lint**: For each script run, state pass/fail and paste the relevant output (summary and any errors or warnings). If a script is missing (e.g. no `lint`), say so in one line (e.g. "No lint script in package.json") and do not run it.
- **Test overview**: List which tests (unit and/or e2e) cover the changed code or related behavior. Name files and describe what they assert (e.g. `tests/unit/ollama.test.mjs` – payload and cleanResponseText).
- **Run tests**: Run `pnpm test` and, if the change touches extension UI or flows, `pnpm run e2e` (or `HEADLESS=1 pnpm run e2e`). Paste the relevant output (summary and any failures).
- **Review**: Note any failing build/lint step and whether it is caused by the reviewed changes. Note any missing test coverage for the changed behavior and suggest new test cases only if there is a clear gap.

---

## Constraints

- Do not change any file unless the user asks for a fix or refactor.
- Base the review only on **local changes** (working tree and/or staged) and **history of those files**; do not invent diffs.
- Keep suggestions aligned with project goals: minimal, stable, small edits (see AGENTS.md).
- If there are no changes (e.g. clean working tree), say so and ask for a path or branch to review.
